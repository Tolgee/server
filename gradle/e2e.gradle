import java.time.Duration

def E2E_DIR = "${project.projectDir}/e2e"
def WEBAPP_DIR = "${project.projectDir}/webapp"

task waitForRunningContainer(type: Task, group: "e2e") {
    doLast {
        while (true) {
            def pb = new ProcessBuilder("docker-compose", "logs")
            pb.directory(new File(E2E_DIR))
            def proc = pb.start()
            BufferedReader stdInput = new BufferedReader(new InputStreamReader(proc.getInputStream()))
            String s = null
            proc.waitFor()
            while ((s = stdInput.readLine()) != null) {
                if (s.contains("Tomcat started on port(s):")) {
                    return
                }
            }
            if (proc.exitValue() != 0) {
                throw new RuntimeException("Docker-compose logs retuned non zero exit code")
            }
        }
    }
    timeout = Duration.ofSeconds(120)
}

task installE2eDeps(type: Exec, group: "e2e") {
    inputs.file("$E2E_DIR/package.json")
    inputs.file("$E2E_DIR/package-lock.json")
    outputs.dir("$E2E_DIR/node_modules")

    commandLine "npm", "install"
    workingDir E2E_DIR
}

task runE2e(type: Exec, group: "e2e") {
    dependsOn "runDockerE2e", "installE2eDeps"

    commandLine "npm", "run", "cy:run"

    workingDir E2E_DIR

    finalizedBy "stopDockerE2e", "cleanupDockerE2e"
}

task openE2e(type: Exec, group: "e2e") {
    dependsOn "runDockerE2e", "installE2eDeps"

    commandLine "npm", "run", "cy:open"

    workingDir E2E_DIR

    finalizedBy "stopDockerE2e", "cleanupDockerE2e"
}

task openE2eDev(type: Exec, group: "e2e") {
    commandLine "npm", "run", "cy:open"

    environment "CYPRESS_HOST", "http://localhost:8081"

    workingDir E2E_DIR
}

task runWebAppNpmStartE2eDev(type: Exec, group: "e2e") {
    commandLine "npm", "run", "startConcurrently"

    environment "REACT_APP_API_URL", "http://localhost:8201"

    workingDir WEBAPP_DIR
}

task runDockerE2e(type: Exec, group: "e2e") {
    dependsOn "tagDockerLocal"
    commandLine "docker-compose", "up", "-d"
    workingDir E2E_DIR
    finalizedBy "waitForRunningContainer"
}

task runDockerE2eDev(type: Exec, group: "e2e") {
    commandLine "docker-compose", "up", "-d", "postgres", "fakesmtp"
    workingDir E2E_DIR
}

task stopDockerE2e(type: Exec, group: "e2e") {
    commandLine "docker-compose", "stop"
    workingDir E2E_DIR
}

task cleanupDockerE2e(type: Exec, group: "e2e") {
    commandLine "docker-compose", "rm", "-f"
    workingDir E2E_DIR
}

task tagDockerLocal(type: Exec) {
    dependsOn "docker"
    commandLine "docker", "tag", "tolgee/tolgee", "tolgee/tolgee:local"
}
